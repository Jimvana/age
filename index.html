<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Face Detection Camera</title>
    <link rel="preload" href="images/no_face_placeholder.png" as="image">
    <script src="face-api/face-api.js"></script>
    <script src="settings/config.js"></script>
    <script src="settings/ui.js"></script>
</head>
<body>
    <video id="video" autoplay muted playsinline style="position: fixed; top: 0; left: 0; width: 100vw; height: 100vh; object-fit: cover;"></video>
    <img id="noFaceImage" src="images/no_face_placeholder.png" style="position: fixed; top: 0; left: 0; width: 100vw; height: 100vh; object-fit: cover; display: none;" alt="No face detected">
    <canvas id="overlay" style="position: fixed; top: 0; left: 0; width: 100vw; height: 100vh; pointer-events: none; z-index: 10;"></canvas>
    <canvas id="zone-canvas" style="position: fixed; top: 0; left: 0; width: 100vw; height: 100vh; pointer-events: none; z-index: 5;"></canvas>

    <!-- Audio for ID Required alert -->
    <audio id="alertAudio" src="alert.mp3" preload="auto"></audio>

    <!-- Loading overlay -->
    <div id="loading-overlay" style="
        position: fixed;
        top: 0;
        left: 0;
        width: 100vw;
        height: 100vh;
        background: rgba(0, 0, 0, 0.8);
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: center;
        z-index: 1000;
        color: white;
        font-family: Arial, sans-serif;
    ">
        <div style="font-size: 48px; margin-bottom: 20px;">üîÑ</div>
        <div style="font-size: 24px; margin-bottom: 10px;">Loading Face Detection Models...</div>
        <div style="font-size: 16px; opacity: 0.8;">This may take a few seconds</div>
    </div>

    <!-- Instructions overlay (hidden by default) -->
    <div id="instructions" style="
        position: fixed;
        bottom: 20px;
        left: 20px;
        background: rgba(0, 0, 0, 0.7);
        color: white;
        padding: 15px;
        border-radius: 8px;
        font-family: Arial, sans-serif;
        font-size: 14px;
        max-width: 300px;
        z-index: 15;
        display: none;
    ">
        <strong>Face Detection Active</strong><br>
        ‚Ä¢ Red boxes: ID Required (under ${CONFIG.ageGender.ageThreshold})<br>
        ‚Ä¢ Green boxes: Access Granted<br>
        ‚Ä¢ Press 'S' or click ‚öôÔ∏è for settings
    </div>

    <script>
        const video = document.getElementById('video');
        const noFaceImage = document.getElementById('noFaceImage');
        const overlay = document.getElementById('overlay');
        const zoneCanvas = document.getElementById('zone-canvas');
        const loadingOverlay = document.getElementById('loading-overlay');
        const instructions = document.getElementById('instructions');
        const alertAudio = document.getElementById('alertAudio');

        let isModelLoaded = false;
        let detectionInterval = null;
        let lastDetections = [];
        let isAlertPlaying = false;

        // Load face-api models (optimized for age/gender only)
        async function loadModels() {
            try {
                console.log('Loading face detection models...');
                await faceapi.nets.tinyFaceDetector.loadFromUri('./face-api/models/');
                await faceapi.nets.faceLandmark68Net.loadFromUri('./face-api/models/');
                // Skip faceExpressionNet for better performance on low-end devices
                await faceapi.nets.ageGenderNet.loadFromUri('./face-api/models/');
                isModelLoaded = true;
                console.log('Face-api models loaded successfully');

                // Hide loading overlay
                loadingOverlay.style.display = 'none';

                // Update instructions with current settings
                updateInstructions();
            } catch (error) {
                console.error('Error loading models:', error);
                loadingOverlay.innerHTML = `
                    <div style="font-size: 48px; margin-bottom: 20px;">‚ùå</div>
                    <div style="font-size: 24px; margin-bottom: 10px;">Failed to Load Models</div>
                    <div style="font-size: 16px; opacity: 0.8;">${error.message}</div>
                `;
            }
        }

        // Start camera with settings
        async function startCamera() {
            try {
                // Check if mediaDevices is available
                if (!navigator.mediaDevices || !navigator.mediaDevices.getUserMedia) {
                    throw new Error('Camera API not available. This may require HTTPS or a different browser.');
                }

                const stream = await navigator.mediaDevices.getUserMedia({
                    video: {
                        facingMode: CONFIG.camera.facingMode,
                        width: CONFIG.camera.width,
                        height: CONFIG.camera.height,
                        frameRate: CONFIG.camera.frameRate
                    }
                });

                video.srcObject = stream;
                video.addEventListener('loadedmetadata', function() {
                    overlay.width = video.videoWidth;
                    overlay.height = video.videoHeight;
                    zoneCanvas.width = video.videoWidth;
                    zoneCanvas.height = video.videoHeight;
                    loadModels();
                    drawDetectionZone();
                });

                console.log('Camera started successfully');
            } catch (err) {
                console.error("Camera error:", err);
                alert(`Camera access failed: ${err.message}\n\nFor Android tablet, try:\n1. Use Chrome browser\n2. Allow camera permissions\n3. Or use HTTPS`);
            }
        }

        // Draw detection zone visual indicator
        function drawDetectionZone() {
            if (!CONFIG.ui.showDetectionZone) return;

            const ctx = zoneCanvas.getContext('2d');
            ctx.clearRect(0, 0, zoneCanvas.width, zoneCanvas.height);

            const centerX = zoneCanvas.width / 2;
            const centerY = zoneCanvas.height / 2;

            // Draw detection zone circles
            ctx.strokeStyle = `rgba(255, 255, 255, ${CONFIG.ui.zoneOpacity})`;
            ctx.lineWidth = 2;
            ctx.setLineDash([5, 5]);

            // Min distance circle
            const minRadius = CONFIG.faceDetection.minFaceSize;
            ctx.beginPath();
            ctx.arc(centerX, centerY, minRadius, 0, 2 * Math.PI);
            ctx.stroke();

            // Max distance circle
            const maxRadius = CONFIG.faceDetection.maxFaceSize;
            ctx.beginPath();
            ctx.arc(centerX, centerY, maxRadius, 0, 2 * Math.PI);
            ctx.stroke();

            // Label the zones
            ctx.setLineDash([]);
            ctx.fillStyle = `rgba(255, 255, 255, ${CONFIG.ui.zoneOpacity})`;
            ctx.font = '12px Arial';
            ctx.textAlign = 'center';
            ctx.fillText('Detection Zone', centerX, centerY - maxRadius - 20);
            ctx.fillText(`Min: ${CONFIG.faceDetection.minFaceSize}px`, centerX, centerY - minRadius - 10);
            ctx.fillText(`Max: ${CONFIG.faceDetection.maxFaceSize}px`, centerX, centerY - maxRadius + 15);
        }

        // Update instructions text
        function updateInstructions() {
            instructions.innerHTML = `
                <strong>Face Detection Active</strong><br>
                ‚Ä¢ Red boxes: ID Required (under ${CONFIG.ageGender.ageThreshold})<br>
                ‚Ä¢ Green boxes: Access Granted<br>
                ‚Ä¢ Detection zone: ${CONFIG.faceDetection.minFaceSize}-${CONFIG.faceDetection.maxFaceSize}px<br>
                ‚Ä¢ Press 'S' or click ‚öôÔ∏è for settings
            `;
        }

        // Smooth detection results to reduce flickering
        function smoothDetections(newDetections) {
            if (!CONFIG.performance.enableSmoothing) {
                return newDetections;
            }

            // Simple smoothing by averaging with previous detections
            const smoothed = newDetections.map(newDet => {
                const prevDet = lastDetections.find(prev =>
                    Math.abs(prev.detection.box.x - newDet.detection.box.x) < 50 &&
                    Math.abs(prev.detection.box.y - newDet.detection.box.y) < 50
                );

                if (prevDet) {
                    // Smooth age and gender values
                    newDet.age = CONFIG.performance.smoothingFactor * prevDet.age +
                               (1 - CONFIG.performance.smoothingFactor) * newDet.age;
                    newDet.gender = CONFIG.performance.smoothingFactor * prevDet.gender +
                                  (1 - CONFIG.performance.smoothingFactor) * newDet.gender;
                }

                return newDet;
            });

            lastDetections = [...smoothed];
            return smoothed;
        }

        // Detection loop with distance filtering
        async function detectFaces() {
            if (!isModelLoaded || video.videoWidth === 0) {
                detectionInterval = setTimeout(detectFaces, CONFIG.faceDetection.detectionInterval);
                return;
            }

            try {
                const detections = await faceapi.detectAllFaces(
                    video,
                    new faceapi.TinyFaceDetectorOptions({
                        inputSize: 512,
                        scoreThreshold: CONFIG.faceDetection.scoreThreshold
                    })
                ).withAgeAndGender();

                // Limit number of detections
                const limitedDetections = detections.slice(0, CONFIG.performance.maxDetections);

                // Apply distance filtering
                const filteredDetections = limitedDetections.filter(detection => {
                    const box = detection.detection.box;
                    const faceWidth = box.width;
                    const faceHeight = box.height;

                    // Check if face size is within detection range
                    return faceWidth >= CONFIG.faceDetection.minFaceSize &&
                           faceWidth <= CONFIG.faceDetection.maxFaceSize &&
                           faceHeight >= CONFIG.faceDetection.minFaceSize &&
                           faceHeight <= CONFIG.faceDetection.maxFaceSize;
                });

                // Smooth results
                const smoothedDetections = smoothDetections(filteredDetections);

                // Draw detections
                drawDetections(smoothedDetections);

                if (CONFIG.debug.showConsoleLogs) {
                    console.log(`Detected ${smoothedDetections.length} faces in range (${CONFIG.faceDetection.minFaceSize}-${CONFIG.faceDetection.maxFaceSize}px)`);
                }

            } catch (error) {
                console.error('Detection error:', error);
            }

            // Continue detection loop
            detectionInterval = setTimeout(detectFaces, CONFIG.faceDetection.detectionInterval);
        }

        // Draw detection results
        function drawDetections(detections) {
            // Toggle between video and static image based on face detection
            if (detections.length === 0) {
                video.style.visibility = 'hidden';
                noFaceImage.style.display = 'block';
            } else {
                video.style.visibility = 'visible';
                noFaceImage.style.display = 'none';
                // Ensure video is playing when switching back
                if (video.paused || video.ended) {
                    video.play().catch(err => console.error('Video play failed:', err));
                }
            }

            const canvas = overlay;
            const ctx = canvas.getContext('2d');
            ctx.clearRect(0, 0, canvas.width, canvas.height);

            let hasUnderAge = false;

            detections.forEach(detection => {
                const { age, gender } = detection;
                const box = detection.detection.box;

                // Determine border color based on age
                const isUnderAge = age < CONFIG.ageGender.ageThreshold;
                const borderColor = isUnderAge ?
                    CONFIG.ui.borderColors.underAge :
                    CONFIG.ui.borderColors.overAge;

                // Draw detection box
                ctx.strokeStyle = borderColor;
                ctx.lineWidth = 3;
                ctx.strokeRect(box.x, box.y, box.width, box.height);

                // Draw age and gender text
                let displayText = '';
                if (CONFIG.ageGender.showAge) {
                    displayText += `Age: ${Math.round(age)}`;
                }
                if (CONFIG.ageGender.showGender) {
                    if (displayText) displayText += ' | ';
                    displayText += `Gender: ${gender}`;
                }

                if (displayText) {
                    const textX = box.x + box.width / 2;
                    const textY = box.y - 10;

                    ctx.font = `${CONFIG.ui.textSize}px Arial`;
                    ctx.textAlign = "center";
                    ctx.fillStyle = CONFIG.ui.textColor;
                    ctx.strokeStyle = CONFIG.ui.textOutlineColor;
                    ctx.lineWidth = 2;

                    ctx.strokeText(displayText, textX, textY);
                    ctx.fillText(displayText, textX, textY);
                }

                // Add "ID REQUIRED" text for under-age detections
                if (isUnderAge) {
                    hasUnderAge = true;
                    const text = "ID REQUIRED";
                    const textX = box.x + box.width / 2;
                    const textY = box.y + box.height + 25;

                    ctx.font = `${CONFIG.ui.textSize}px Arial`;
                    ctx.textAlign = "center";
                    ctx.fillStyle = CONFIG.ui.textColor;
                    ctx.strokeStyle = CONFIG.ui.textOutlineColor;
                    ctx.lineWidth = 2;

                    ctx.strokeText(text, textX, textY);
                    ctx.fillText(text, textX, textY);
                }
            });

            // Play alert if under-age detected and not already playing
            if (hasUnderAge && !isAlertPlaying) {
                alertAudio.play().catch(err => console.error('Audio play failed:', err));
                isAlertPlaying = true;
            } else if (!hasUnderAge) {
                isAlertPlaying = false;
            }
        }

        // Restart detection (called when settings change)
        window.restartDetection = function() {
            if (detectionInterval) {
                clearTimeout(detectionInterval);
            }
            updateInstructions();
            drawDetectionZone();
            detectFaces();
        };

        // Initialize
        startCamera();

        // Start detection when video is ready
        video.addEventListener('play', () => {
            detectFaces();
        });

        // Handle visibility change (pause/resume detection)
        document.addEventListener('visibilitychange', () => {
            if (document.hidden) {
                if (detectionInterval) {
                    clearTimeout(detectionInterval);
                }
            } else {
                if (isModelLoaded) {
                    detectFaces();
                }
            }
        });
    </script>
</body>
</html>
